#!/usr/bin/env bash

FILE_PRODUCTION="./production.yml"
FILE_DEV="./dev.yml"
FILE_TEST="./test.yml"
FILE_ENV="./.env"

CONTEXT_CERTBOT="certbot"
CONTEXT_DEV="dev"
CONTEXT_PRODUCTION="production"
CONTEXT_TEST="test"

EXPORT_TEMP_DIR="data-export"
DOCKER_CONTAINER_POSTGRES="postgres"

compose_file=""
context="$1"
shift

log() {
  echo "$*" >"$(tty)"
}

run_command() {
  log "COMMAND: '$*'"
  "$@"
}

# Short-circuit for simple commands that don't require a build context.
case $context in
  "pull")
    run_command git pull --recurse-submodules
    exit 0
    ;;
esac

show_help() {
  log 'bma (dev | production | test | certbot | pull | export)'
  log ''
  log 'dev'
  log 'production'
  log 'test'
  log 'certbot (init|renew)'
  log 'pull'
  log 'export'
}

docker_compose() {
  run_command docker compose -f "$compose_file" "$@"
}

docker_compose_build() {
  docker_compose build --progress=plain --ssh=default "$@"
}

production_build() {
  # Run `docker compose build` with required values from .env file.
  source "$FILE_ENV"
  docker_compose_build \
    --build-arg GIT_HASH="$(git rev-parse --short HEAD)" \
    --build-arg WEBMAIL_CONTACT_EMAIL="$WEBMAIL_CONTACT_EMAIL" \
    --build-arg GOOGLE_RECAPTCHA_TOKEN="$GOOGLE_RECAPTCHA_TOKEN" \
    --build-arg SITE_NAME="$SITE_NAME" \
    "$@"
}

export_data() {
  source "$FILE_ENV"

  temp_dir="/tmp/$EXPORT_TEMP_DIR"

  output_filename="export-$(date +%F).tar.gz"
  run_command mkdir -p "$temp_dir"

  run_command cp -r "$MEDIA_ROOT" "$temp_dir"
  run_command docker exec -t "$DOCKER_CONTAINER_POSTGRES" pg_dumpall -c -U beatonma > "$temp_dir/db.sql"
  run_command tar -czvf "$output_filename" -C "/tmp" "$EXPORT_TEMP_DIR"
}

production() {
  if [ $# -eq 0 ]; then
    production_build
    exit 0
  fi

  case "$1" in
    "build")
      shift
      production_build "$@"
      exit 0
      ;;
    "up" | "down" | "--")
      docker_compose "$@"
      exit 0
      ;;
    "export")
      export_data "$@"
      exit 0
      ;;
    *)
      log "Unhandled arguments '$*'"
      exit 1
      ;;
  esac
}

dev() {
  case "$1" in
    "up" | "down" | "--")
      docker_compose "$@"
      ;;
    *)
      docker_compose_build
      docker_compose up "$@"
      ;;
  esac

  exit 0
}

runtests() {
  case "$1" in
    "dev")
      # Keep the Django server running after tests complete - use with `cypress`..
      shift
      docker_compose up "$@"
      ;;
    "cypress")
      # Run cypress tests on running Django server - use with `dev`.
      docker_compose up cypress
      ;;
    "--")
      shift
      docker_compose "$@"
      ;;
    *)
      docker_compose up --abort-on-container-exit "$@"
      ;;
  esac

  exit 0
}

certbot_init() {
  # Run this before first run of production server.
  run_command docker run --rm \
    --name certbot_init \
    --volume letsencrypt_keys:/etc/letsencrypt:rw \
    --volume letsencrypt_webroot:/var/www/letsencrypt:rw \
    --env-file "$FILE_ENV" \
    --entrypoint "" \
    -p 80:80 \
    certbot/certbot:latest \
    sh -c "certbot certonly --standalone $*"
}

certbot_renew() {
  # Run this periodically to update while production server is running.
  run_command docker run --rm \
    --name certbot_renew \
    --volume letsencrypt_keys:/etc/letsencrypt:rw \
    --volume letsencrypt_webroot:/var/www/letsencrypt:rw \
    --env-file "$FILE_ENV" \
    --entrypoint "" \
    certbot/certbot:latest \
    sh -c "certbot certonly --webroot -w /var/www/letsencrypt $*"
}

certbot() {
  source "$FILE_ENV"

  common_args_list=(
    "-d ${DOMAIN_NAME}"
    "-d www.${DOMAIN_NAME}"
    "--email ${DOMAIN_EMAIL}"
    "--rsa-key-size 4096"
    "--keep-until-expiring"
    "--agree-tos"
    "--non-interactive"
  )

  # Concat list to string
  common_args=$(printf "%s " "${common_args_list[@]}")

  case "$1" in
    "init")
      shift
      certbot_init "$common_args"
      ;;
    "renew")
      shift
      certbot_renew "$common_args"
      ;;
  esac

  exit 0
}

case $context in
  "$CONTEXT_PRODUCTION")
    compose_file=$FILE_PRODUCTION
    production "$@"
    ;;
  "$CONTEXT_DEV")
    compose_file=$FILE_DEV
    dev "$@"
    ;;
  "$CONTEXT_TEST")
    compose_file=$FILE_TEST
    runtests "$@"
    ;;
  "$CONTEXT_CERTBOT")
    certbot "$@"
    ;;
  *)
    log "Unhandled context '$context'"
    exit 1
    ;;
esac
